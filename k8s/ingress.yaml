---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: agentic-devops-ingress
  annotations:
    # Use Azure Application Gateway Ingress Controller
    kubernetes.io/ingress.class: azure/application-gateway
    # Enable SSL redirect for HTTPS
    appgw.ingress.kubernetes.io/ssl-redirect: "true"
    # Connection draining timeout
    appgw.ingress.kubernetes.io/connection-draining: "true"
    appgw.ingress.kubernetes.io/connection-draining-timeout: "30"
    # Backend protocol
    appgw.ingress.kubernetes.io/backend-protocol: "http"
    # Request timeout
    appgw.ingress.kubernetes.io/request-timeout: "30"
    # Health probe configuration for better reliability
    appgw.ingress.kubernetes.io/health-probe-interval: "30"
    appgw.ingress.kubernetes.io/health-probe-timeout: "5"
    appgw.ingress.kubernetes.io/health-probe-unhealthy-threshold: "3"
    # Use certificate from Application Gateway (configured via Terraform)
    appgw.ingress.kubernetes.io/appgw-ssl-certificate: "appgw-ssl-certificate"
spec:
  # TLS configuration for HTTPS
  tls:
    - secretName: appgw-ssl-certificate
      hosts:
        - agentic-devops.local
        - "*.agentic-devops.local"
  rules:
    # Default rule for IP-based or hostname-based access
    # Accessible via Application Gateway Public IP or configured domain
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: agentic-devops-service
                port:
                  number: 80
    # Optional: Add hostname-specific rule
    - host: agentic-devops.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: agentic-devops-service
                port:
                  number: 80
